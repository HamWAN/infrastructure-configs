---
- include: query-ros.yml

- name: Configure temp DNS servers before upgrade
  raw: /ip dns set servers=8.8.8.8,8.8.4.4

- include: upgrade-ros.yml

- name: Copy netadmin certificates to router
  raw: "/tool fetch url=\"{{ KEYS_URL }}{{ item }}.key\""
  with_items: NETOPS_USERS
  tags:
    - common
    - import

- name: Copy limted user certificates to router
  raw: "/tool fetch url=\"{{ KEYS_URL }}{{ item }}.key\""
  with_items: LIMITED_USERS
  tags: 
    - common
    - import

- name: Create template for common changes
  local_action: template src=common.j2 dest=roles/common-mikrotik-routers/generated-scripts/common.rsc backup=no
  tags:
    - generate
    - common

- name: "run commands on device"
  raw: >
       "{{ item }}"
  with_lines: cat ../generated-scripts/common.rsc
  tags: 
    - import
    - common
  register: import_result

- name: "remove script from device"
  raw: "/file remove common.rsc"
  tags: 
    - cleanup
    - common

- name: remove script from generated-scripts directory
  local_action: file path=./roles/common-mikrotik-routers/generated-scripts/common.rsc state=absent
  tags: 
    - cleanup
    - common
