---
# use ls -m *.npk to get the file list
- name: Copy upgrade files to router
  action: command scp -P {{ ansible_ssh_port }} ./roles/common-mikrotik-routers/files/{{ item }} {{ ansible_ssh_user }}@{{ ansible_ssh_host }}:/
  with_items: [advanced-tools-6.29.1-mipsbe.npk, calea-6.29.1-mipsbe.npk, dhcp-6.29.1-mipsbe.npk, gps-6.29.1-mipsbe.npk, hotspot-6.29.1-mipsbe.npk, ipv6-6.29.1-mipsbe.npk, lcd-6.29.1-mipsbe.npk, mpls-6.29.1-mipsbe.npk,multicast-6.29.1-mipsbe.npk, ntp-6.29.1-mipsbe.npk, openflow-6.29.1-mipsbe.npk, ppp-6.29.1-mipsbe.npk, routeros-mipsbe-6.29.1.npk, routing-6.29.1-mipsbe.npk, security-6.29.1-mipsbe.npk, system-6.29.1-mipsbe.npk,ups-6.29.1-mipsbe.npk, user-manager-6.29.1-mipsbe.npk, wireless-6.29.1-mipsbe.npk, wireless-fp-6.29.1-mipsbe.npk]
  tags: 
    - import
    - upgrade-ros

- name: Create template
  template: src=upgrade.j2 dest=./roles/common-mikrotik-routers/generated-scripts/upgrade.rsc backup=no
  tags: 
    - generate
    - upgrade-ros

- name: Copy script to router
  action: command scp -P {{ ansible_ssh_port }} ./roles/common-mikrotik-routers/generated-scripts/upgrade.rsc {{ ansible_ssh_user }}@{{ ansible_ssh_host }}:/
  tags: 
    - import
    - upgrade-ros

- name: "import script on device"
  action: command ssh -p {{ ansible_ssh_port }} {{ ansible_ssh_user }}@{{ ansible_ssh_host }} "/import verbose=yes upgrade.rsc"
  tags: 
    - import
    - upgrade-ros
  register: import_result

- name: "import script on device failed"
  action: fail msg="importing script common.rsc on {{ inventory_hostname }} failed"
  tags: 
    - import
    - upgrade-ros
  when: "'failure:' in import_result.stdout"

- pause: seconds=30
  tags:
    - upgrade-ros

- name: Wait for server to restart
  local_action:
    module: wait_for
      host={{ ansible_ssh_host }}
      port={{ ansible_ssh_port }}
      delay=1
      timeout=300
  tags:
    - upgrade-ros
 
- name: "remove script from device"
  action: command ssh -p {{ ansible_ssh_port }} {{ ansible_ssh_user }}@{{ ansible_ssh_host }} "/file remove upgrade.rsc"
  tags: 
    - cleanup
    - upgrade-ros
