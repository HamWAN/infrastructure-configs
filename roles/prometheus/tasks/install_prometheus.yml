- name: Generate default script
  template:
    backup=no
    dest=/srv/prometheus/prometheus.yml
    src=prometheus.yml.j2
    mode="u=rw,g=r,o=r"
- name:
  file: path=/srv/prometheus/tgroups/ state=directory

- name: Install prometheus
  docker:
    name: prometheus
    image: prom/prometheus
    state: reloaded
    pull: always
    command: -alertmanager.url=http://{{ inventory_hostname }}:9093 -config.file=/etc/prometheus/prometheus.yml
    ports:
    - "9090:9090"
    volumes:
    - /srv/prometheus:/etc/prometheus/

- name: Get iptables rules
  command: /bin/cat /etc/rc.local
  register: iptablesrules
  always_run: yes

#- name: Add prometheus-console iptable rule
#  lineinfile:
#    dest=/etc/rc.local
#    line="iptables -A INPUT -p tcp --dport 9090 -j ACCEPT"
#    insertbefore="iptables -P INPUT DROP"
#    state="present"
#  when: iptablesrules.stdout.find("9090") == -1  
